<!DOCTYPE html>
<html>

<head>
    <title>Pong</title>
</head>

<canvas id="pong" width="600" height="400"></canvas>

<script>
    const canv = document.getElementById("pong");
    const ctx = canv.getContext("2d");
    //user
    const user = {
        x : 0,
        y : canv.height/2 -100/2,
        width : 10,
        height : 100,
        color : "WHITE",
        score : 0
    }
    // computer 
    const comp = {
        x : canv.width - 10,
        y : canv.height/2 -100/2,
        width : 10,
        height : 100,
        color : "WHITE",
        score : 0
    }
    // ball
    const ball = {
        x : canv.width/2,
        y : canv.height/2,
        radius : 10,
        speed : 5,
        velocityX : 5,
        velocityY : 5,
        color : "WHITE"
    }
    // net
    const net = {
        x : canv.width/2 - 1,
        y : 0,
        width : 2,
        height : 10,
        color : "WHITE"
    }
    //document.addEventListener("keydown", keyPush);
    //setInterval(game, 1000 / 15);

    // draw a rectangle
    function drawRect(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
    }

    //draw a circle
    function drawCircle(x, y, r, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI*2, false);
        ctx.closePath();
        ctx.fill();
    }

    // draw text 
    function drawText(text, x, y, color) {
        ctx.fillStyle = color;
        ctx.font = "45px fantasy";
        ctx.fillText(text, x, y);
    }

    // draw net
    function drawNet() {
        for (let i = 0; i <= canv.height; i+=15) {
            drawRect(net.x, net.y + i, net.width, net.height, net.color);
        }
    }

    //rendering the canvas
    function render() {
        // clear the canvas
        drawRect(0, 0, canv.width, canv.height, "BLACK");
        // draw nets
        drawNet();
        // draw score
        drawText(user.score, canv.width/4, canv.height/5, "WHITE");
        drawText(comp.score, 3 * canv.width/4, canv.height/5, "WHITE");
        // draw the paddles
        drawRect(user.x, user.y, user.width, user.height, user.color);
        drawRect(comp.x, comp.y, comp.width, comp.height, comp.color);
        // draw the ball
        drawCircle(ball.x, ball.y, ball.radius, ball.color);
    }
    // control the user paddle;
    canv.addEventListener("mousemove", movePaddle);
    function movePaddle(evt) {
        let rect = canv.getBoundingClientRect();
        user.y = evt.clientY - rect.top - user.height/2;
    }

    // collision detection
    function collision(b, p) {
        b.top = b.y - b.radius;
        b.bottom = b.y + b.radius;
        b.left = b.x - b.radius;
        b.right = b.x + b.radius;
        
        p.top = p.y;
        p.bottom = p.y + p.height;
        p.left = p.x;
        p.right = p.x + p.width;

        return b.right > p.left && b.bottom > p.top && b.left < p.right && b.top < p.bottom;
    }

    // reset ball upon scoring
    function resetBall() {
        ball.x = canv.width/2;
        ball.y = canv.height/2;

        ball.speed = 5;
        ball.velocityX = Math.floor(Math.random()*5) + 1;
    }

    // update : pos mov and score....
    function update() {
        ball.x += ball.velocityX;
        ball.y += ball.velocityY;

        // ai
        let level = 0.07;
        comp.y += (ball.y - (comp.y + comp.height/2)) * level;

        if (ball.y + ball.radius > canv.height || ball.y - ball.radius < 0) {
            ball.velocityY =- ball.velocityY;
        }

        let player = (ball.x < canv.width/2) ? user : comp;
        
        if (collision(ball, player)) {
            let point = ball.y - (player.y + player.height/2);
            // normalization
            point = point / (player.height / 2);
            // cal angle in rad
            let angleRad = point * Math.PI/4;
            // x direction changes
            let direction = (ball.x < canv.width/2) ? 1 : -1;
            // changing vel
            ball.velocityX = direction * ball.speed * Math.cos(angleRad);
            ball.velocityY = direction * ball.speed * Math.sin(angleRad);
            // increase everytime ball is hit
            ball.speed += 0.1;
        }
        // update scoring
        if (ball.x - ball.radius < 0) {
            // comp scores
            comp.score++;
            resetBall();
        }
        if (ball.x + ball.radius > canv.width) {
            // user scores
            user.score++;
            resetBall();
        }

    }
    // game init
    function game() {
        update();
        render();
    }

    // game loop
    const framePerSecond = 60;
    setInterval(game, 1000/framePerSecond);

</script>

</html>